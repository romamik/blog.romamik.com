---
import type { MarkdownHeading } from "astro";
import MainLayout from "../../layouts/MainLayout.astro";
import { getPosts } from "../../lib/blog";
import HeadingTree from "../../layouts/HeadingTree.astro";

export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings: mdHeadings } = await post.render();
const {
  data: { title },
  formattedDate,
} = post;

// Helper function: build a nested tree based on heading.depth
type Heading = MarkdownHeading & {
  children?: Heading[];
  parent?: Heading;
};
function buildHeadingTree(headings: MarkdownHeading[]): Heading[] {
  let current: Heading = { text: title, slug: "title-top", depth: 0 };
  for (const mdHeading of headings) {
    while (current.parent && mdHeading.depth <= current.depth) {
      current = current.parent;
    }
    const heading = { ...mdHeading, parent: current };
    if (!current.children) current.children = [];
    current.children.push(heading);
    current = heading;
  }
  while (current.parent) {
    current = current.parent;
  }
  return [current];
}

const headings = buildHeadingTree(mdHeadings);
---

<MainLayout title={title}>
  <sub>{formattedDate}</sub>
  <h1 id="title-top">{title}</h1>
  <Content />
  <div slot="toc" class="prose prose-sm dark:prose-invert max-w-none">
    <HeadingTree {headings} />
  </div>
</MainLayout>
